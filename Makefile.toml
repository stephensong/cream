[config]
default_to_workspace = false

[tasks.build]
description = "Build all contracts, delegate, and UI"
dependencies = ["build-contracts", "build-delegate", "build-ui"]

[tasks.build-contracts]
description = "Build WASM contracts"
dependencies = ["build-directory-contract", "build-storefront-contract"]

[tasks.build-directory-contract]
description = "Build directory contract WASM"
command = "cargo"
args = ["build", "-p", "cream-directory-contract", "--target", "wasm32-unknown-unknown", "--release", "--features", "contract"]

[tasks.build-storefront-contract]
description = "Build storefront contract WASM"
command = "cargo"
args = ["build", "-p", "cream-storefront-contract", "--target", "wasm32-unknown-unknown", "--release", "--features", "contract"]

[tasks.build-contracts-dev]
description = "Build WASM contracts with dev feature (no signature checks)"
dependencies = ["build-directory-contract-dev", "build-storefront-contract-dev"]

[tasks.build-directory-contract-dev]
description = "Build directory contract WASM with dev feature"
command = "cargo"
args = ["build", "-p", "cream-directory-contract", "--target", "wasm32-unknown-unknown", "--release", "--features", "contract,dev"]

[tasks.build-storefront-contract-dev]
description = "Build storefront contract WASM with dev feature"
command = "cargo"
args = ["build", "-p", "cream-storefront-contract", "--target", "wasm32-unknown-unknown", "--release", "--features", "contract,dev"]

[tasks.build-delegate]
description = "Build CREAM delegate"
command = "cargo"
args = ["build", "-p", "cream-delegate", "--release"]

[tasks.build-ui]
description = "Build UI with dx"
cwd = "ui"
command = "dx"
args = ["build", "--release"]

[tasks.dev]
description = "Run UI development server"
cwd = "ui"
command = "dx"
args = ["serve"]

[tasks.dev-example-no-sync]
description = "Run UI dev server with example data and no sync"
cwd = "ui"
command = "dx"
args = ["serve"]
[tasks.dev-example-no-sync.env]
CARGO_FEATURE_EXAMPLE_DATA = "1"
CARGO_FEATURE_NO_SYNC = "1"

[tasks.dev-connected]
description = "Run UI dev server connected to local Freenet node"
dependencies = ["build-contracts-dev"]
cwd = "ui"
command = "dx"
args = ["serve", "--features", "use-node"]

[tasks.local-network]
description = "Start local Freenet network (1 gateway + 2 nodes)"
script = ["cd ${FREENET_CORE}/scripts && unset MAKEFLAGS && export N_GATEWAYS=1 N_NODES=2 FREENET_CORE_PATH=${FREENET_CORE}/crates/core && make -e -f local-network.mk setup start"]
[tasks.local-network.env]
FREENET_CORE = { value = "${HOME}/dev/freenet-core", condition = { env_not_set = ["FREENET_CORE"] } }

[tasks.local-network-stop]
description = "Stop local Freenet network"
script = ["cd ${FREENET_CORE}/scripts && unset MAKEFLAGS && export FREENET_CORE_PATH=${FREENET_CORE}/crates/core && make -e -f local-network.mk stop"]
[tasks.local-network-stop.env]
FREENET_CORE = { value = "${HOME}/dev/freenet-core", condition = { env_not_set = ["FREENET_CORE"] } }

[tasks.dev-android]
description = "Run UI dev server for Android with remote Freenet node"
dependencies = ["build-contracts-dev"]
cwd = "ui"
command = "dx"
args = ["serve", "--platform", "android", "--features", "mobile,use-node", "--no-default-features"]
[tasks.dev-android.env]
CREAM_NODE_URL = { value = "${CREAM_NODE_URL}", condition = { env_set = ["CREAM_NODE_URL"] } }

[tasks.dev-ios]
description = "Run UI dev server for iOS with remote Freenet node"
dependencies = ["build-contracts-dev"]
cwd = "ui"
command = "dx"
args = ["serve", "--platform", "ios", "--features", "mobile,use-node", "--no-default-features"]
[tasks.dev-ios.env]
CREAM_NODE_URL = { value = "${CREAM_NODE_URL}", condition = { env_set = ["CREAM_NODE_URL"] } }

[tasks.build-android]
description = "Build release APK for Android"
dependencies = ["build-contracts"]
cwd = "ui"
command = "dx"
args = ["build", "--release", "--platform", "android", "--features", "mobile,use-node", "--no-default-features"]
[tasks.build-android.env]
CREAM_NODE_URL = { value = "${CREAM_NODE_URL}", condition = { env_set = ["CREAM_NODE_URL"] } }

[tasks.build-ios]
description = "Build release for iOS"
dependencies = ["build-contracts"]
cwd = "ui"
command = "dx"
args = ["build", "--release", "--platform", "ios", "--features", "mobile,use-node", "--no-default-features"]
[tasks.build-ios.env]
CREAM_NODE_URL = { value = "${CREAM_NODE_URL}", condition = { env_set = ["CREAM_NODE_URL"] } }

# ─── Customer App ─────────────────────────────────────────────────────────────

[tasks.dev-customer-web]
description = "Run customer web app for browser testing (single storefront, rendezvous lookup)"
dependencies = ["build-contracts-dev"]
cwd = "ui"
command = "dx"
args = ["serve", "--features", "use-node,customer"]

[tasks.dev-customer-android]
description = "Run customer Android app in emulator"
dependencies = ["build-contracts-dev"]
cwd = "ui"
command = "dx"
args = ["serve", "--platform", "android", "--features", "mobile,use-node,customer", "--no-default-features"]
[tasks.dev-customer-android.env]
CREAM_NODE_URL = { value = "${CREAM_NODE_URL}", condition = { env_set = ["CREAM_NODE_URL"] } }

[tasks.build-customer-android]
description = "Build release customer APK for Android"
dependencies = ["build-contracts"]
cwd = "ui"
command = "dx"
args = ["build", "--release", "--platform", "android", "--features", "mobile,use-node,customer", "--no-default-features"]
[tasks.build-customer-android.env]
CREAM_NODE_URL = { value = "${CREAM_NODE_URL}", condition = { env_set = ["CREAM_NODE_URL"] } }

[tasks.reset-node]
description = "Stop Freenet node, wipe contract state, and restart (dev only)"
script = [
    "pkill -9 -x freenet || true",
    "sleep 2",
    "rm -rf ${HOME}/.local/share/freenet/db ${HOME}/.cache/freenet/gw1/db",
    "echo 'Node state cleared. Restarting...'",
    "nohup freenet local --ws-api-port 3001 > /dev/null 2>&1 &",
    "sleep 1",
    "echo 'Freenet node restarted on port 3001'",
]

[tasks.test]
description = "Run all tests"
command = "cargo"
args = ["test", "--workspace"]

[tasks.test-node]
description = "Build contracts, reset multi-node network, and run integration tests"
dependencies = ["build-contracts-dev", "reset-network"]
command = "cargo"
args = ["test", "-p", "cream-node-integration", "--features", "node-tests", "--", "--nocapture"]

[tasks.fixture]
description = "Full manual-testing fixture: build contracts, start network, run tests, launch UI dev server"
dependencies = ["test-node"]
cwd = "ui"
command = "dx"
args = ["serve", "--features", "use-node"]

[tasks.reset-network]
description = "Stop all Freenet processes, wipe state, start multi-node network (1 gateway + 2 nodes)"
script = [
    '''
    set -euo pipefail
    BASE="${HOME}/.cache/freenet"
    KEYS="${BASE}/keys"
    PIDS="${BASE}/pids"
    LOGS="${BASE}/logs"
    ENV="RUST_BACKTRACE=1 RUST_LOG=info"

    # Stop existing processes (SIGKILL to ensure they die quickly)
    pkill -9 -x freenet 2>/dev/null || true
    sleep 2

    # Wipe node state and stale config (nodes share config-dir, so config.toml conflicts)
    rm -rf "${BASE}/gw1/db" "${BASE}/n1/db" "${BASE}/n2/db" "${HOME}/.local/share/freenet/db"
    rm -f "${BASE}/config.toml"
    mkdir -p "${KEYS}" "${PIDS}" "${LOGS}" "${BASE}/gw1" "${BASE}/n1" "${BASE}/n2"

    # Generate X25519 transport keypair if missing
    if [ ! -f "${KEYS}/gw1_private_key.pem" ] || head -1 "${KEYS}/gw1_private_key.pem" | grep -q "BEGIN"; then
        echo "Generating X25519 transport keypair..."
        python3 -c "
from cryptography.hazmat.primitives.asymmetric.x25519 import X25519PrivateKey
import binascii, os
private_key = X25519PrivateKey.generate()
priv_hex = binascii.hexlify(private_key.private_bytes_raw()).decode()
pub_hex = binascii.hexlify(private_key.public_key().public_bytes_raw()).decode()
print(priv_hex, end='')
open('${KEYS}/gw1_public_key.pem', 'w').write(pub_hex)
" > "${KEYS}/gw1_private_key.pem"
        echo "  Keys written to ${KEYS}/"
    fi

    echo "Starting gateway on ws:3001..."
    : > "${LOGS}/gw1.log"
    nohup env ${ENV} freenet network \
        --skip-load-from-network \
        --config-dir "${BASE}" \
        --is-gateway \
        --ws-api-port 3001 \
        --public-network-address 127.0.0.1 \
        --public-network-port 3101 \
        --data-dir "${BASE}/gw1" \
        --transport-keypair "${KEYS}/gw1_private_key.pem" \
        --network-port 3101 \
        >> "${LOGS}/gw1.log" 2>&1 &
    echo $! > "${PIDS}/gw1.pid"

    # Wait for gateway to be ready (it clobbers gateways.toml on startup)
    for i in $(seq 1 15); do
        if ss -tlnp 2>/dev/null | grep -q ':3001 '; then break; fi
        sleep 1
    done

    # Write gateways.toml AFTER gateway starts (freenet overwrites it during init)
    # Also remove config.toml that the gateway persists (contains is_gateway=true
    # and the gateway's transport_keypair — nodes sharing config-dir would inherit these)
    cat > "${BASE}/gateways.toml" << TOML
[[gateways]]
address = { host_address = "127.0.0.1:3101" }
public_key = "${KEYS}/gw1_public_key.pem"
TOML
    rm -f "${BASE}/config.toml"

    echo "Starting node-1 on ws:3002..."
    : > "${LOGS}/n1.log"
    nohup env ${ENV} freenet network \
        --skip-load-from-network \
        --config-dir "${BASE}" \
        --ws-api-port 3002 \
        --public-network-port 3003 \
        --data-dir "${BASE}/n1" \
        --network-port 3102 \
        >> "${LOGS}/n1.log" 2>&1 &
    echo $! > "${PIDS}/n1.pid"
    sleep 2

    echo "Starting node-2 on ws:3003..."
    : > "${LOGS}/n2.log"
    nohup env ${ENV} freenet network \
        --skip-load-from-network \
        --config-dir "${BASE}" \
        --ws-api-port 3003 \
        --public-network-port 3004 \
        --data-dir "${BASE}/n2" \
        --network-port 3103 \
        >> "${LOGS}/n2.log" 2>&1 &
    echo $! > "${PIDS}/n2.pid"
    sleep 2

    # Verify all three are running
    RUNNING=0
    for port in 3001 3002 3003; do
        if ss -tlnp 2>/dev/null | grep -q ":${port} "; then
            RUNNING=$((RUNNING + 1))
        else
            echo "WARNING: no listener on port ${port}"
            case ${port} in
                3001) tail -5 "${LOGS}/gw1.log" 2>/dev/null ;;
                3002) tail -5 "${LOGS}/n1.log" 2>/dev/null ;;
                3003) tail -5 "${LOGS}/n2.log" 2>/dev/null ;;
            esac
        fi
    done

    if [ "${RUNNING}" -eq 3 ]; then
        echo "Multi-node network ready: gateway=3001, node-1=3002, node-2=3003"
    else
        echo "ERROR: Only ${RUNNING}/3 nodes started. Check logs in ${LOGS}/"
        exit 1
    fi
    ''',
]

[tasks.check]
description = "Check all code compiles"
command = "cargo"
args = ["check", "--workspace"]

[tasks.fmt]
description = "Format all code"
command = "cargo"
args = ["fmt", "--all"]

[tasks.clippy]
description = "Run clippy on all code"
command = "cargo"
args = ["clippy", "--all-targets"]

[tasks.lint]
description = "Format and lint"
dependencies = ["fmt", "clippy"]

# ─── Rendezvous Service ──────────────────────────────────────────────────────

[tasks.rendezvous-install]
description = "Install rendezvous service dependencies"
cwd = "rendezvous"
script = ["npm install"]

[tasks.dev-rendezvous]
description = "Run rendezvous service locally (wrangler dev)"
dependencies = ["rendezvous-install"]
cwd = "rendezvous"
command = "npx"
args = ["wrangler", "dev"]

# ─── Tailwind CSS ─────────────────────────────────────────────────────────────

[tasks.tailwind-install]
description = "Install Tailwind CSS dependencies"
cwd = "ui"
script = ["npm install"]

[tasks.tailwind-build]
description = "Build Tailwind CSS (one-shot)"
cwd = "ui"
script = ["npx @tailwindcss/cli -i ./input.css -o ./assets/tailwind.css"]

[tasks.tailwind-watch]
description = "Watch and rebuild Tailwind CSS on changes"
cwd = "ui"
script = ["npx @tailwindcss/cli -i ./input.css -o ./assets/tailwind.css --watch"]

# ─── E2E Browser Tests ───────────────────────────────────────────────────────

[tasks.e2e-install]
description = "Install Playwright and browser dependencies"
cwd = "tests/e2e"
script = ["npm install", "npx playwright install chromium"]

[tasks.e2e-build]
description = "Build UI with dx for E2E testing"
dependencies = ["tailwind-install", "tailwind-build"]
cwd = "ui"
command = "dx"
args = ["build", "--features", "use-node"]

[tasks.e2e-serve]
description = "Serve pre-built UI assets on port 8080 for E2E tests"
dependencies = ["e2e-build"]
script = [
    "nohup python3 -m http.server 8080 --directory ui/target/dx/cream-ui/debug/web/public > /tmp/cream-e2e-server.log 2>&1 &",
    "echo $! > /tmp/cream-e2e-server.pid",
    "for i in $(seq 1 10); do curl -s http://localhost:8080 > /dev/null 2>&1 && echo 'Static server ready on port 8080' && exit 0; sleep 1; done",
    "echo 'Timed out waiting for static server' && exit 1",
]

[tasks.e2e-stop]
description = "Stop the E2E static server"
script = [
    "if [ -f /tmp/cream-e2e-server.pid ]; then kill $(cat /tmp/cream-e2e-server.pid) 2>/dev/null || true; rm -f /tmp/cream-e2e-server.pid; echo 'Static server stopped'; else echo 'No server PID file found'; fi",
]

[tasks.e2e-run]
description = "Run Playwright E2E tests"
cwd = "tests/e2e"
command = "npx"
args = ["playwright", "test"]

[tasks.e2e-run-headed]
description = "Run Playwright E2E tests in headed mode (visible browser)"
cwd = "tests/e2e"
command = "npx"
args = ["playwright", "test", "--headed"]

[tasks.test-e2e]
description = "Full E2E pipeline: build contracts, reset node, start server, run tests, stop server"
dependencies = ["build-contracts-dev", "test-node", "e2e-install", "e2e-serve"]
script = [
    '''
    cleanup() {
        if [ -f /tmp/cream-e2e-server.pid ]; then
            kill $(cat /tmp/cream-e2e-server.pid) 2>/dev/null || true
            rm -f /tmp/cream-e2e-server.pid
            echo "Static server stopped"
        fi
    }
    trap cleanup EXIT
    cd tests/e2e && npx playwright test
    ''',
]
