[config]
default_to_workspace = false

[tasks.build]
description = "Build all contracts, delegate, and UI"
dependencies = ["build-contracts", "build-delegate", "build-ui"]

[tasks.build-contracts]
description = "Build WASM contracts"
dependencies = ["build-directory-contract", "build-storefront-contract"]

[tasks.build-directory-contract]
description = "Build directory contract WASM"
command = "cargo"
args = ["build", "-p", "cream-directory-contract", "--target", "wasm32-unknown-unknown", "--release", "--features", "contract"]

[tasks.build-storefront-contract]
description = "Build storefront contract WASM"
command = "cargo"
args = ["build", "-p", "cream-storefront-contract", "--target", "wasm32-unknown-unknown", "--release", "--features", "contract"]

[tasks.build-contracts-dev]
description = "Build WASM contracts with dev feature (no signature checks)"
dependencies = ["build-directory-contract-dev", "build-storefront-contract-dev"]

[tasks.build-directory-contract-dev]
description = "Build directory contract WASM with dev feature"
command = "cargo"
args = ["build", "-p", "cream-directory-contract", "--target", "wasm32-unknown-unknown", "--release", "--features", "contract,dev"]

[tasks.build-storefront-contract-dev]
description = "Build storefront contract WASM with dev feature"
command = "cargo"
args = ["build", "-p", "cream-storefront-contract", "--target", "wasm32-unknown-unknown", "--release", "--features", "contract,dev"]

[tasks.build-delegate]
description = "Build CREAM delegate"
command = "cargo"
args = ["build", "-p", "cream-delegate", "--release"]

[tasks.build-ui]
description = "Build UI with dx"
cwd = "ui"
command = "dx"
args = ["build", "--release"]

[tasks.dev]
description = "Run UI development server"
cwd = "ui"
command = "dx"
args = ["serve"]

[tasks.dev-example-no-sync]
description = "Run UI dev server with example data and no sync"
cwd = "ui"
command = "dx"
args = ["serve"]
[tasks.dev-example-no-sync.env]
CARGO_FEATURE_EXAMPLE_DATA = "1"
CARGO_FEATURE_NO_SYNC = "1"

[tasks.dev-connected]
description = "Run UI dev server connected to local Freenet node"
dependencies = ["build-contracts-dev"]
cwd = "ui"
command = "dx"
args = ["serve", "--features", "use-node"]

[tasks.local-network]
description = "Start local Freenet network (1 gateway + 2 nodes)"
script = ["make -f ${FREENET_CORE}/scripts/local-network.mk setup start N_GATEWAYS=1 N_NODES=2 FREENET_CORE_PATH=${FREENET_CORE}/crates/core"]
[tasks.local-network.env]
FREENET_CORE = { value = "${HOME}/dev/freenet-core", condition = { env_not_set = ["FREENET_CORE"] } }

[tasks.local-network-stop]
description = "Stop local Freenet network"
script = ["make -f ${FREENET_CORE}/scripts/local-network.mk stop FREENET_CORE_PATH=${FREENET_CORE}/crates/core"]
[tasks.local-network-stop.env]
FREENET_CORE = { value = "${HOME}/dev/freenet-core", condition = { env_not_set = ["FREENET_CORE"] } }

[tasks.dev-android]
description = "Run UI dev server for Android with remote Freenet node"
dependencies = ["build-contracts-dev"]
cwd = "ui"
command = "dx"
args = ["serve", "--platform", "android", "--features", "mobile,use-node", "--no-default-features"]
[tasks.dev-android.env]
CREAM_NODE_URL = { value = "${CREAM_NODE_URL}", condition = { env_set = ["CREAM_NODE_URL"] } }

[tasks.dev-ios]
description = "Run UI dev server for iOS with remote Freenet node"
dependencies = ["build-contracts-dev"]
cwd = "ui"
command = "dx"
args = ["serve", "--platform", "ios", "--features", "mobile,use-node", "--no-default-features"]
[tasks.dev-ios.env]
CREAM_NODE_URL = { value = "${CREAM_NODE_URL}", condition = { env_set = ["CREAM_NODE_URL"] } }

[tasks.build-android]
description = "Build release APK for Android"
dependencies = ["build-contracts"]
cwd = "ui"
command = "dx"
args = ["build", "--release", "--platform", "android", "--features", "mobile,use-node", "--no-default-features"]
[tasks.build-android.env]
CREAM_NODE_URL = { value = "${CREAM_NODE_URL}", condition = { env_set = ["CREAM_NODE_URL"] } }

[tasks.build-ios]
description = "Build release for iOS"
dependencies = ["build-contracts"]
cwd = "ui"
command = "dx"
args = ["build", "--release", "--platform", "ios", "--features", "mobile,use-node", "--no-default-features"]
[tasks.build-ios.env]
CREAM_NODE_URL = { value = "${CREAM_NODE_URL}", condition = { env_set = ["CREAM_NODE_URL"] } }

[tasks.reset-node]
description = "Stop Freenet node, wipe contract state, and restart (dev only)"
script = [
    "pkill -x freenet || true",
    "sleep 1",
    "rm -rf ${HOME}/.local/share/freenet/db ${HOME}/.cache/freenet/gw1/db",
    "echo 'Node state cleared. Restarting...'",
    "nohup freenet local --ws-api-port 3001 > /dev/null 2>&1 &",
    "sleep 1",
    "echo 'Freenet node restarted on port 3001'",
]

[tasks.test]
description = "Run all tests"
command = "cargo"
args = ["test", "--workspace"]

[tasks.test-node]
description = "Reset node and run integration tests against it"
dependencies = ["reset-node"]
command = "cargo"
args = ["test", "-p", "cream-node-integration", "--features", "node-tests", "--", "--nocapture"]

[tasks.check]
description = "Check all code compiles"
command = "cargo"
args = ["check", "--workspace"]

[tasks.fmt]
description = "Format all code"
command = "cargo"
args = ["fmt", "--all"]

[tasks.clippy]
description = "Run clippy on all code"
command = "cargo"
args = ["clippy", "--all-targets"]

[tasks.lint]
description = "Format and lint"
dependencies = ["fmt", "clippy"]
